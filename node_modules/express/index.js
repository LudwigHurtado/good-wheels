const http = require('http');
const { URL } = require('url');

function createApp() {
  const middlewares = [];
  const routes = [];

  const app = {
    use(pathOrFn, maybeFn) {
      if (typeof pathOrFn === 'string' && maybeFn && maybeFn.__isRouter) {
        for (const route of maybeFn.__routes) {
          routes.push({ ...route, path: `${pathOrFn}${route.path}`.replace(/\/\//g, '/') });
        }
        return;
      }

      if (pathOrFn && pathOrFn.__isRouter) {
        for (const route of pathOrFn.__routes) {
          routes.push(route);
        }
        return;
      }

      middlewares.push(pathOrFn);
    },
    get(path, handler) { routes.push({ method: 'GET', path, handler }); },
    post(path, handler) { routes.push({ method: 'POST', path, handler }); },
    patch(path, handler) { routes.push({ method: 'PATCH', path, handler }); },
    listen(port, cb) {
      const server = http.createServer(async (req, res) => {
        enhanceResponse(res);
        req.params = {};
        req.body = undefined;

        for (const mw of middlewares) {
          await runMiddleware(mw, req, res);
          if (res.writableEnded) {
            return;
          }
        }

        const pathname = new URL(req.url, `http://${req.headers.host}`).pathname;
        const route = matchRoute(routes, req.method, pathname);

        if (!route) {
          res.status(404).json({ error: 'Not found' });
          return;
        }

        req.params = route.params;
        route.handler(req, res);
      });

      return server.listen(port, cb);
    },
  };

  return app;
}

function Router() {
  const routes = [];
  return {
    __isRouter: true,
    __routes: routes,
    get(path, handler) { routes.push({ method: 'GET', path, handler }); },
    post(path, handler) { routes.push({ method: 'POST', path, handler }); },
    patch(path, handler) { routes.push({ method: 'PATCH', path, handler }); },
  };
}

function json() {
  return (req, _res) => new Promise((resolve) => {
    let body = '';
    req.on('data', (chunk) => { body += chunk; });
    req.on('end', () => {
      if (!body) {
        req.body = {};
        resolve();
        return;
      }

      try {
        req.body = JSON.parse(body);
      } catch (_e) {
        req.body = {};
      }
      resolve();
    });
  });
}

function runMiddleware(mw, req, res) {
  return new Promise((resolve) => {
    if (mw.length >= 3) {
      mw(req, res, resolve);
    } else {
      Promise.resolve(mw(req, res)).then(resolve);
    }
  });
}

function matchRoute(routes, method, pathname) {
  for (const route of routes) {
    if (route.method !== method) continue;

    const keys = [];
    const regex = new RegExp(`^${route.path.replace(/:[^/]+/g, (token) => {
      keys.push(token.slice(1));
      return '([^/]+)';
    })}$`);

    const match = pathname.match(regex);
    if (match) {
      const params = {};
      keys.forEach((k, i) => { params[k] = match[i + 1]; });
      return { ...route, params };
    }
  }

  return null;
}

function enhanceResponse(res) {
  res.status = function status(code) {
    res.statusCode = code;
    return res;
  };

  res.json = function jsonBody(payload) {
    res.setHeader('Content-Type', 'application/json');
    res.end(JSON.stringify(payload));
  };
}

module.exports = createApp;
module.exports.Router = Router;
module.exports.json = json;
